/*! WoW Progression v1.0beta
	by Rob G (Mottie)
	https://github.com/Mottie/wowProgression
	http://www.opensource.org/licenses/mit-license.php
*/
;(function(n){n.fn.wowProgression=function(G){return this.each(function(){if(!this.initialized){var D=this,a=n.extend({region:"us",locale:"en_US",server:"Lightning's Blade",guild:"Our Guild's Name",raiders:{},show:["mists"],heroics:!0,ratio:0.75,count:"{p}",status:"{s}",useAbbr:!1,text:{zero:"",none:"",killed:"Killed"},tooltip:"tooltip",allexps:{mists:"Mists of Pandaria",cat:"Catacylsm"},allraids:{mists:[{abbr:"ToES",hasHeroic:!0,name:"Terrace of Endless Spring",icons:[60583,62442,62983,60999]},{abbr:"HoF", hasHeroic:!0,name:"Heart of Fear",icons:[62980,62543,62164,62397,62511,62837]},{abbr:"MV",hasHeroic:!0,name:"Mogu'shan Vaults",icons:[60051,60009,60143,60701,60410,60396]}],cat:[{abbr:"DS",hasHeroic:!0,name:"Dragon Soul",icons:[55265,55308,55312,55689,55294,56427,53879,57962]},{abbr:"FL",hasHeroic:!0,name:"Firelands",icons:[52498,52558,53691,52530,53494,52571,52409]},{abbr:"ToFW",hasHeroic:!0,name:"Throne of the Four Winds",icons:[45871,46753]},{abbr:"BoT",hasHeroic:!0,name:"The Bastion of Twilight", icons:[44600,45993,43687,43324,45213],heroicBoss:!0},{abbr:"BD",hasHeroic:!0,name:"Blackwing Descent",icons:[42179,41570,41442,43296,41378,41376]},{abbr:"BH",hasHeroic:!1,name:"Baradin Hold",icons:[47120,52363,55869]}]},initialized:null},G),H="http://"+("cn"===a.region?"www.battlenet.com.cn":a.region+".battle.net")+"/api/wow/character/"+escape(a.server)+"/",q=[],r={},F=[],p;p=function(g){return jQuery.getJSON(H+escape(g)+"?locale="+a.locale+"&fields=progression&jsonp=?",function(a){a&&a.progression&& (F.push(a.name),q.push(a.progression.raids))})};var g=function(a){return a.replace(/'/g,"'").replace(/"/g,"&quot;")},d,b,e,h,i=[],E=[];for(b in a.raiders)if(a.raiders.hasOwnProperty(b)&&("all"===b||0<=n.inArray(b,a.show))){d=a.raiders[b];for(e=0;e<d.length;e++)if(i.push(d[e]),"all"===b)for(h=0;h<a.show.length;h++)r[a.show[h]]||(r[a.show[h]]=[]),r[a.show[h]].push(d[e]);else r[b]||(r[b]=[]),r[b].push(d[e])}i=n.grep(i,function(a,c){return n.inArray(a,i)===c});for(d=0;d<i.length;d++)E.push(p(i[d]));E.length&& (p=n.when.apply(n,E),p.done(function(){var d,c,b,f,j,e,s,h,i,t,u,y,z,l="",A,B,w,x,C,m,p,v,k;for(d=0;d<a.show.length;d++){v=a.show[d];m=a.allraids[v];k=r[v].length;l+='<h3 class="expansion expansion-'+v+'">'+a.allexps[v]+'</h3><div class="instances instances-'+v+'">';for(c=0;c<m.length;c++)if(q[0])for(b=0;b<q[0].length;b++)if((C=q[0][b]||null)&&C.name===m[c].name){x=w="";p=C.bosses;h=i=0;u=t=C.bosses.length;for(f=0;f<p.length;f++)if(m[c].icons[f]){for(j=A=z=B=y=0;j<k;j++)e=n.inArray(r[v][j],F),0<= e&&(0<q[e][b].bosses[f].normalKills&&(y++,B+=q[e][b].bosses[f].normalKills),0<q[e][b].bosses[f].heroicKills&&(z++,A+=q[e][b].bosses[f].heroicKills));y/k>=a.ratio&&i++;z/k>=a.ratio&&h++;j=g(a.status).replace(/\{(s|n)\}/g,function(b){return{"{s}":y/k>=a.ratio?g(a.text.killed):g(a.text.none),"{n}":B/k<a.ratio?g(a.text.zero):Math.ceil(B/k)}[b]});m[c].heroicBoss&&f===C.bosses.length-1?u=t-1:w+="<div class='boss "+(y/k>=a.ratio?"boss-killed":"")+"'><img class='boss-icon' src='http://media.blizzard.com/wow/renders/npcs/portrait/creature"+ m[c].icons[f]+".jpg'><span class='boss-name'>"+g(p[f].name)+"</span><span class='boss-status'>"+j+"</span></div>";a.heroics&&(j=g(a.status).replace(/\{(s|n)\}/g,function(b){return{"{s}":z/k>=a.ratio?g(a.text.killed):g(a.text.none),"{n}":A/k<a.ratio?g(a.text.zero):Math.ceil(A/k)}[b]}),x+="<div class='boss "+(z/k>=a.ratio?"boss-killed":"")+"'><img class='boss-icon' src='http://media.blizzard.com/wow/renders/npcs/portrait/creature"+m[c].icons[f]+".jpg'><span class='boss-name'>"+g(p[f].name)+"</span><span class='boss-status'>"+ j+"</span></div>")}else t-=1,u-=1;s=Math.round(100*(i/u))+"%";j=a.count.replace(/\{[n|p|t]\}/g,function(a){return{"{p}":s,"{n}":i,"{t}":u}[a]});w="<div class='inst'><div class='inst-title'>Normal <span class='inst-count'>"+i+"/"+u+" ("+s+")</span></div></div>"+w;l+='<table class="instance inst-'+m[c].abbr+'"><tr><td'+(a.heroics&&m[c].hasHeroic?' rowspan="2"':"")+' class="icon"><div class="icon"></div></td><td><span class="inst-name">'+m[c][a.useAbbr?"abbr":"name"]+'</span><div class="bar-bkgd bar-normal '+ a.tooltip+'" title="<div class=tips>'+w+'</div>"><div class="bar-color" style="width: '+s+';"><span class="bar-text">'+j+"</span></div></td></tr>";a.heroics&&m[c].hasHeroic&&(s=Math.round(100*(h/t))+"%",j=a.count.replace(/\{[n|p|t]\}/g,function(a){return{"{p}":s,"{n}":h,"{t}":t}[a]}),x="<div class='inst'><div class='inst-title'>Heroic <span class='inst-count'>"+h+"/"+t+" ("+s+")</span></div></div>"+x,l+='<tr><td><div class="bar-bkgd bar-heroic '+a.tooltip+'" title="<div class=tips>'+x+'"><div class="bar-color" style="width: '+ s+';"><span class="bar-text">'+j+"</span></div></div></td></tr>");l+="</div>"}l+="</table></div>"}n(D).addClass("wowprogression").html(l);D.initialized=!0;D.initialized=!0;"function"===typeof a.initialized&&a.initialized(D)}))}})}})(jQuery);

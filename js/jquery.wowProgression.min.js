/*! WoW Progression v1.0
	by Rob G (Mottie)
	https://github.com/Mottie/wowProgression
	http://www.opensource.org/licenses/mit-license.php
*/
;(function(n){n.fn.wowProgression=function(K){return this.each(function(){if(!this.initialized){var F=this,a=n.extend({region:"us",locale:"en_US",server:"Lightning's Blade",guild:"Our Guild's Name",raiders:{},show:["mists"],heroics:!0,ratio:0.75,count:"{p}",status:"{s}",useAbbr:!1,text:{zero:"",none:"",killed:"Killed"},tooltip:"tooltip",allexps:{mists:"Mists of Pandaria",cat:"Catacylsm"},allraids:{mists:[{abbr:"ToES",hasHeroic:!0,name:"Terrace of Endless Spring",icons:[60583,62442,62983,60999]},{abbr:"HoF", hasHeroic:!0,name:"Heart of Fear",icons:[62980,62543,62164,62397,62511,62837]},{abbr:"MV",hasHeroic:!0,name:"Mogu'shan Vaults",icons:[60051,60009,60143,60701,60410,60396]}],cat:[{abbr:"DS",hasHeroic:!0,name:"Dragon Soul",icons:[55265,55308,55312,55689,55294,56427,53879,57962]},{abbr:"FL",hasHeroic:!0,name:"Firelands",icons:[52498,52558,53691,52530,53494,52571,52409]},{abbr:"ToFW",hasHeroic:!0,name:"Throne of the Four Winds",icons:[45871,46753]},{abbr:"BoT",hasHeroic:!0,name:"The Bastion of Twilight", icons:[44600,45993,43687,43324,45213],heroicBoss:!0},{abbr:"BD",hasHeroic:!0,name:"Blackwing Descent",icons:[42179,41570,41442,43296,41378,41376]},{abbr:"BH",hasHeroic:!1,name:"Baradin Hold",icons:[47120,52363,55869]}]},initialized:null,details:!1,clickForDetails:!0},K),L="http://"+("cn"===a.region?"www.battlenet.com.cn":a.region+".battle.net")+"/api/wow/character/"+escape(a.server)+"/",t=[],u={},J=[],s;s=function(c){return jQuery.getJSON(L+escape(c)+"?locale="+a.locale+"&fields=progression&jsonp=?", function(a){a&&a.progression&&(J.push(a.name.toLocaleLowerCase()),t.push(a.progression.raids))})};var r=function(a){return a.replace(/'/g,"'").replace(/"/g,"&quot;")},c,d,j,k,e=[],I=[];for(d in a.raiders)if(a.raiders.hasOwnProperty(d)&&("all"===d||0<=n.inArray(d,a.show))){c=a.raiders[d];for(j=0;j<c.length;j++)if(""!==c[j])if(e.push(c[j]),"all"===d)for(k=0;k<a.show.length;k++)u[a.show[k]]||(u[a.show[k]]=[]),u[a.show[k]].push(c[j]);else u[d]||(u[d]=[]),u[d].push(c[j])}e=n.grep(e,function(a,c){return n.inArray(a, e)===c});for(c=0;c<e.length;c++)e[c]&&(e[c]=e[c].toLocaleLowerCase(),I.push(s(e[c])));I.length&&(s=n.when.apply(n,I),s.done(function(){var c,i,d,f,b,g,e,j,k,A,v,y,B,C,s,w,x,p="",D,E,l,m,G,q,H,z,h;for(c=0;c<a.show.length;c++){z=a.show[c];q=a.allraids[z];h=u[z].length;p+='<h3 class="expansion expansion-'+z+'">'+a.allexps[z]+'</h3><div class="instances instances-'+z+'">';for(i=0;i<q.length;i++)if(t[0])for(d=0;d<t[0].length;d++)if((G=t[0][d]||null)&&G.name===q[i].name){m=l="";s=[];w=[];x=[];H=G.bosses; k=A=0;y=v=H.length;for(f=0;f<v;f++)if(q[i].icons[f]){s.push(f+1);for(b=D=C=E=B=0;b<h;b++)j=u[z][b],g=n.inArray((j||"").toLocaleLowerCase(),J),0<=g&&(w[b]||(w[b]=[j]),x[b]||(x[b]=[j]),0<t[g][d].bosses[f].normalKills?(w[b].push("+"),B++,E+=t[g][d].bosses[f].normalKills):w[b].push("-"),0<t[g][d].bosses[f].heroicKills?(x[b].push("+"),C++,D+=t[g][d].bosses[f].heroicKills):x[b].push("-"));B/h>=a.ratio&&A++;C/h>=a.ratio&&k++;g=r(a.status).replace(/\{(s|n)\}/g,function(b){return{"{s}":B/h>=a.ratio?r(a.text.killed): r(a.text.none),"{n}":E/h<a.ratio?r(a.text.zero):Math.ceil(E/h)}[b]});q[i].heroicBoss&&f===G.bosses.length-1?y=v-1:l+="<div class='boss "+(B/h>=a.ratio?"boss-killed":"")+"'><img class='boss-icon' src='http://media.blizzard.com/wow/renders/npcs/portrait/creature"+q[i].icons[f]+".jpg'><span class='boss-name'>"+r(H[f].name)+"</span><span class='boss-status'>"+g+"</span></div>";a.heroics&&(g=r(a.status).replace(/\{(s|n)\}/g,function(b){return{"{s}":C/h>=a.ratio?r(a.text.killed):r(a.text.none),"{n}":D/ h<a.ratio?r(a.text.zero):Math.ceil(D/h)}[b]}),m+="<div class='boss "+(C/h>=a.ratio?"boss-killed":"")+"'><img class='boss-icon' src='http://media.blizzard.com/wow/renders/npcs/portrait/creature"+q[i].icons[f]+".jpg'><span class='boss-name'>"+r(H[f].name)+"</span><span class='boss-status'>"+g+"</span></div>")}else v-=1,y-=1;e=Math.round(100*(A/y))+"%";g=a.count.replace(/\{[n|p|t]\}/g,function(a){return{"{p}":e,"{n}":A,"{t}":y}[a]});l="<div class='inst'><div class='inst-title'>Normal <span class='inst-count'>"+ A+"/"+y+" ("+e+")</span></div></div>"+l;l+="<div class='details'"+(a.details?"":" style='display:none'")+"><hr><table><tr><td>Raider</td><td class='mono'>"+s.join(" ")+"</td></tr>";for(b=0;b<h;b++)w[b]&&(l+="<tr><td>"+w[b].shift()+"</td><td class='mono'>"+w[b].join(" ")+"</td></tr>");l+="</table></div>";p+='<table class="instance inst-'+q[i].abbr+'"><tr><td'+(a.heroics&&q[i].hasHeroic?' rowspan="2"':"")+' class="icon"><div class="icon"></div></td><td><span class="inst-name">'+q[i][a.useAbbr?"abbr": "name"]+'</span><div class="bar-bkgd bar-normal '+a.tooltip+'" title="<div class=tips>'+l+'</div>"><div class="bar-color" style="width: '+e+';"><span class="bar-text">'+g+"</span></div></td></tr>";if(a.heroics&&q[i].hasHeroic){e=Math.round(100*(k/v))+"%";g=a.count.replace(/\{[n|p|t]\}/g,function(a){return{"{p}":e,"{n}":k,"{t}":v}[a]});m="<div class='inst'><div class='inst-title'>Heroic <span class='inst-count'>"+k+"/"+v+" ("+e+")</span></div></div>"+m;m+="<div class='details'"+(a.details?"":" style='display:none'")+ "><hr><table><tr><td>Raider</td><td class='mono'>"+s.join(" ")+"</td></tr>";for(b=0;b<h;b++)x[b]&&(m+="<tr><td>"+x[b].shift()+"</td><td class='mono'>"+x[b].join(" ")+"</td></tr>");m+="</table></div>";p+='<tr><td><div class="bar-bkgd bar-heroic '+a.tooltip+'" title="<div class=tips>'+m+'"><div class="bar-color" style="width: '+e+';"><span class="bar-text">'+g+"</span></div></div></td></tr>"}p+="</div>"}p+="</table></div>"}n(F).addClass("wowprogression").html(p);!a.details&&a.clickForDetails&&n(F).find(".bar-bkgd").bind("click", function(){n(".tips .details").toggle()});F.initialized=!0;"function"===typeof a.initialized&&a.initialized(F)}))}})}})(jQuery);

/*! WoW Progression v1.4.0
	by Rob G (Mottie)
	https://github.com/Mottie/wowProgression
	http://www.opensource.org/licenses/mit-license.php
*/
;(function(p){p.fn.wowProgression=function(R){return this.each(function(){if(!this.initialized){var F=this,a=p.extend({region:"us",locale:"en_US",server:"Lightning's Blade",guild:"Our Guild's Name",raiders:{},show:["mists"],heroics:!0,ratio:0.75,count:"{p}",status:"{s}",useAbbr:!1,text:{zero:"",none:"",killed:"Killed"},tooltip:"tooltip",allexps:{mists:"Mists of Pandaria",cat:"Catacylsm"},allraids:{mists:[{abbr:"SoO",hasHeroic:!0,id:6738,icons:[71543,71475,71965,71734,72249,72616,71859,71515,71454, 71889,71529,71504,71152,71865]},{abbr:"ToT",hasHeroic:!0,id:6622,icons:[69465,68476,69078,67977,68066,68177,67827,69017,69427,68078,68904,68397,69473],heroicBoss:!0},{abbr:"ToES",hasHeroic:!0,id:6067,icons:[60583,62442,62983,60999]},{abbr:"HoF",hasHeroic:!0,id:6297,icons:[62980,62543,62164,62397,62511,62837]},{abbr:"MV",hasHeroic:!0,id:6125,icons:[60051,60009,60143,60701,60410,60396]}],cat:[{abbr:"DS",hasHeroic:!0,id:5892,icons:[55265,55308,55312,55689,55294,56427,53879,57962]},{abbr:"FL",hasHeroic:!0, id:5723,icons:[52498,52558,53691,52530,53494,52571,52409]},{abbr:"ToFW",hasHeroic:!0,id:5638,icons:[45871,46753]},{abbr:"BoT",hasHeroic:!0,id:5334,icons:[44600,45993,43687,43324,45213],heroicBoss:!0},{abbr:"BD",hasHeroic:!0,id:5094,icons:[42179,41570,41442,43296,41378,41376]},{abbr:"BH",hasHeroic:!1,id:5600,icons:[47120,52363,55869]}]},initialized:null,details:!1,clickForDetails:!0,debug:!1},R),G="http://"+("cn"===a.region?"www.battlenet.com.cn":a.region+".battle.net")+"/api/wow/character/"+a.server+ "/",u=[],v={},M=[],q,N=!1,D={},H=function(a){console&&console.log&&console.log(a)},S=function(e){return jQuery.getJSON(G+e+"?locale="+a.locale+"&fields=progression&jsonp=?",function(c){if(c&&c.progression){var e=c.name.toLocaleLowerCase();M.push(e);u.push(c.progression.raids);a.debug&&H([e,"URL: "+G+e+"?locale="+a.locale+"&fields=progression",c])}})},s=function(a){return a.replace(/'/g,"'").replace(/"/g,"&quot;")},Q=function(){if(!N){var e,c,h,d,b,f,w,L,q,I,x,A,B,E,O,P,y,z,G,r="",J,K,l,m,t,k,C,n, g;for(e=0;e<a.show.length;e++){n=a.show[e];a.debug&&(D[n]={});k=a.allraids[n];g=v[n].length;r+='<h3 class="expansion expansion-'+n+'">'+a.allexps[n]+'</h3><div class="instances instances-'+n+'">';for(c=0;c<k.length;c++)if(u[0])for(h=0;h<u[0].length;h++)if((t=u[0][h]||null)&&t.id===k[c].id){k[c].name=t.name;a.debug&&(D[n][t.name]={});m=l="";O=[];P=[];y=[];z=[];C=t.bosses;q=I=0;A=x=C.length;for(d=0;d<x;d++)if(k[c].icons[d]){(G=!k[c].heroicBoss||k[c].heroicBoss&&d<t.bosses.length-1)&&O.push(d+1);P.push(d+ 1);for(b=J=E=K=B=0;b<g;b++)L=v[n][b],f=p.inArray((L||"").toLocaleLowerCase(),M),0<=f&&(y[b]||(y[b]=[L]),z[b]||(z[b]=[L]),G&&(0<u[f][h].bosses[d].normalKills?(y[b].push("+"),B++,K+=u[f][h].bosses[d].normalKills):y[b].push("-")),0<u[f][h].bosses[d].heroicKills?(z[b].push("+"),E++,J+=u[f][h].bosses[d].heroicKills):z[b].push("-"));B/g>=a.ratio&&I++;E/g>=a.ratio&&q++;f=s(a.status).replace(/\{(s|n)\}/g,function(b){return{"{s}":B/g>=a.ratio?s(a.text.killed):s(a.text.none),"{n}":K/g<a.ratio?s(a.text.zero): Math.ceil(K/g)}[b]});k[c].heroicBoss&&d===t.bosses.length-1?A=x-1:(l+="<div class='boss "+(B/g>=a.ratio?"boss-killed":"")+"'><img class='boss-icon' src='http://media.blizzard.com/wow/renders/npcs/portrait/creature"+k[c].icons[d]+".jpg'><span class='boss-name'>"+s(C[d].name)+"</span><span class='boss-status'>"+f+"</span></div>",a.debug&&(D[n][t.name][C[d].name]="ratio: "+B/g+", normal: "+(B/g>=a.ratio?"+":"-")+", "));a.heroics&&(f=s(a.status).replace(/\{(s|n)\}/g,function(b){return{"{s}":E/g>=a.ratio? s(a.text.killed):s(a.text.none),"{n}":J/g<a.ratio?s(a.text.zero):Math.ceil(J/g)}[b]}),m+="<div class='boss "+(E/g>=a.ratio?"boss-killed":"")+"'><img class='boss-icon' src='http://media.blizzard.com/wow/renders/npcs/portrait/creature"+k[c].icons[d]+".jpg'><span class='boss-name'>"+s(C[d].name)+"</span><span class='boss-status'>"+f+"</span></div>",a.debug&&(D[n][t.name][C[d].name]=(D[n][t.name][C[d].name]||"")+"heroic: "+(E/g>=a.ratio?"+":"-")))}else x-=1,A-=1;w=Math.round(100*(I/A))+"%";f=a.count.replace(/\{[n|p|t]\}/g, function(a){return{"{p}":w,"{n}":I,"{t}":A}[a]});l="<div class='inst'><div class='inst-title'>Normal <span class='inst-count'>"+I+"/"+A+" ("+w+")</span></div></div>"+l;l+="<div class='details'"+(a.details?"":" style='display:none'")+"><hr><table><tr><td>Raider</td><td class='mono'>"+O.join(" ")+"</td></tr>";for(b=0;b<g;b++)y[b]&&(l+="<tr><td>"+y[b].shift()+"</td><td class='mono'>"+y[b].join(" ")+"</td></tr>");l+="</table></div>";r+='<table class="instance inst-'+k[c].abbr+'"><tr><td'+(a.heroics&& k[c].hasHeroic?' rowspan="2"':"")+' class="icon"><div class="icon"></div></td><td><span class="inst-name">'+k[c][a.useAbbr?"abbr":"name"]+'</span><div class="bar-bkgd bar-normal '+a.tooltip+'" title="<div class=tips>'+l+'</div>"><div class="bar-color" style="width: '+w+';"><span class="bar-text">'+f+"</span></div></td></tr>";if(a.heroics&&k[c].hasHeroic){w=Math.round(100*(q/x))+"%";f=a.count.replace(/\{[n|p|t]\}/g,function(a){return{"{p}":w,"{n}":q,"{t}":x}[a]});m="<div class='inst'><div class='inst-title'>Heroic <span class='inst-count'>"+ q+"/"+x+" ("+w+")</span></div></div>"+m;m+="<div class='details'"+(a.details?"":" style='display:none'")+"><hr><table><tr><td>Raider</td><td class='mono'>"+P.join(" ")+"</td></tr>";for(b=0;b<g;b++)z[b]&&(m+="<tr><td>"+z[b].shift()+"</td><td class='mono'>"+z[b].join(" ")+"</td></tr>");m+="</table></div>";r+='<tr><td><div class="bar-bkgd bar-heroic '+a.tooltip+'" title="<div class=tips>'+m+'"><div class="bar-color" style="width: '+w+';"><span class="bar-text">'+f+"</span></div></div></td></tr>"}r+= "</div>"}r+="</table></div>"}a.debug&&H(D);p(F).addClass("wowprogression").html(r);!a.details&&a.clickForDetails&&p(F).find(".bar-bkgd").unbind("click").bind("click",function(){p(".tips .details").toggle()});"function"!==typeof a.initialized||F.initialized||a.initialized(F);F.initialized=!0}};q=function(){var e,c,h,d,b=[],f=[];for(c in a.raiders)if(a.raiders.hasOwnProperty(c)&&("all"===c||0<=p.inArray(c,a.show))){e=a.raiders[c];for(h=0;h<e.length;h++)if(""!==e[h])if(b.push(e[h]),"all"===c)for(d=0;d< a.show.length;d++)v[a.show[d]]||(v[a.show[d]]=[]),v[a.show[d]].push(e[h]);else v[c]||(v[c]=[]),v[c].push(e[h]);a.debug&&H("Expansion ("+c+") raiders: "+e)}b=p.grep(b,function(a,c){return p.inArray(a,b)===c});for(e=0;e<b.length;e++)b[e]&&(b[e]=b[e].toLocaleLowerCase(),f.push(S(b[e])));return f}();q.length&&(q=p.when.apply(p,q),q.done(function(){a.debug&&H("Loading complete: processing...");Q();N=!0}),setTimeout(function(){0<M.length&&(a.debug&&!N&&H("One or more raiders' JSON feeds failed to load..."), Q())},2E3))}})}})(jQuery);

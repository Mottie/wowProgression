/*! WoW Progression v1.2 beta
	by Rob G (Mottie)
	https://github.com/Mottie/wowProgression
	http://www.opensource.org/licenses/mit-license.php
*/
;(function(m){m.fn.wowProgression=function(K){return this.each(function(){if(!this.initialized){var F=this,a=m.extend({region:"us",locale:"en_US",server:"Lightning's Blade",guild:"Our Guild's Name",raiders:{},show:["mists"],heroics:!0,ratio:0.75,count:"{p}",status:"{s}",useAbbr:!1,text:{zero:"",none:"",killed:"Killed"},tooltip:"tooltip",allexps:{mists:"Mists of Pandaria",cat:"Catacylsm"},allraids:{mists:[{abbr:"ToES",hasHeroic:!0,name:"Terrace of Endless Spring",icons:[60583,62442,62983,60999]},{abbr:"HoF", hasHeroic:!0,name:"Heart of Fear",icons:[62980,62543,62164,62397,62511,62837]},{abbr:"MV",hasHeroic:!0,name:"Mogu'shan Vaults",icons:[60051,60009,60143,60701,60410,60396]}],cat:[{abbr:"DS",hasHeroic:!0,name:"Dragon Soul",icons:[55265,55308,55312,55689,55294,56427,53879,57962]},{abbr:"FL",hasHeroic:!0,name:"Firelands",icons:[52498,52558,53691,52530,53494,52571,52409]},{abbr:"ToFW",hasHeroic:!0,name:"Throne of the Four Winds",icons:[45871,46753]},{abbr:"BoT",hasHeroic:!0,name:"The Bastion of Twilight", icons:[44600,45993,43687,43324,45213],heroicBoss:!0},{abbr:"BD",hasHeroic:!0,name:"Blackwing Descent",icons:[42179,41570,41442,43296,41378,41376]},{abbr:"BH",hasHeroic:!1,name:"Baradin Hold",icons:[47120,52363,55869]}]},initialized:null,details:!1,clickForDetails:!0},K),L="http://"+("cn"===a.region?"www.battlenet.com.cn":a.region+".battle.net")+"/api/wow/character/"+escape(a.server)+"/",t=[],u={},J=[],s;s=function(c){return jQuery.getJSON(L+escape(c)+"?locale="+a.locale+"&fields=progression&jsonp=?", function(a){a&&a.progression&&(J.push(a.name.toLocaleLowerCase()),t.push(a.progression.raids))})};var r=function(a){return a.replace(/'/g,"'").replace(/"/g,"&quot;")},c,d,n,j,e=[],I=[];for(d in a.raiders)if(a.raiders.hasOwnProperty(d)&&("all"===d||0<=m.inArray(d,a.show))){c=a.raiders[d];for(n=0;n<c.length;n++)if(e.push(c[n]),"all"===d)for(j=0;j<a.show.length;j++)u[a.show[j]]||(u[a.show[j]]=[]),u[a.show[j]].push(c[n]);else u[d]||(u[d]=[]),u[d].push(c[n])}e=m.grep(e,function(a,c){return m.inArray(a, e)===c});for(c=0;c<e.length;c++)e[c]&&(e[c]=e[c].toLocaleLowerCase(),I.push(s(e[c])));I.length&&(s=m.when.apply(m,I),s.done(function(){var c,i,d,f,b,g,e,n,j,A,v,w,B,C,s,x,y,p="",D,E,k,l,G,q,H,z,h;for(c=0;c<a.show.length;c++){z=a.show[c];q=a.allraids[z];h=u[z].length;p+='<h3 class="expansion expansion-'+z+'">'+a.allexps[z]+'</h3><div class="instances instances-'+z+'">';for(i=0;i<q.length;i++)if(t[0])for(d=0;d<t[0].length;d++)if((G=t[0][d]||null)&&G.name===q[i].name){l=k="";s=[];x=[];y=[];H=G.bosses; j=A=0;w=v=H.length;for(f=0;f<v;f++)if(q[i].icons[f]){s.push(f+1);for(b=D=C=E=B=0;b<h;b++)n=u[z][b],g=m.inArray((n||"").toLocaleLowerCase(),J),0<=g&&(x[b]||(x[b]=[n]),y[b]||(y[b]=[n]),0<t[g][d].bosses[f].normalKills?(x[b].push("+"),B++,E+=t[g][d].bosses[f].normalKills):x[b].push("-"),0<t[g][d].bosses[f].heroicKills?(y[b].push("+"),C++,D+=t[g][d].bosses[f].heroicKills):y[b].push("-"));B/h>=a.ratio&&A++;C/h>=a.ratio&&j++;g=r(a.status).replace(/\{(s|n)\}/g,function(b){return{"{s}":B/h>=a.ratio?r(a.text.killed): r(a.text.none),"{n}":E/h<a.ratio?r(a.text.zero):Math.ceil(E/h)}[b]});q[i].heroicBoss&&f===G.bosses.length-1?w=v-1:k+="<div class='boss "+(B/h>=a.ratio?"boss-killed":"")+"'><img class='boss-icon' src='http://media.blizzard.com/wow/renders/npcs/portrait/creature"+q[i].icons[f]+".jpg'><span class='boss-name'>"+r(H[f].name)+"</span><span class='boss-status'>"+g+"</span></div>";a.heroics&&(g=r(a.status).replace(/\{(s|n)\}/g,function(b){return{"{s}":C/h>=a.ratio?r(a.text.killed):r(a.text.none),"{n}":D/ h<a.ratio?r(a.text.zero):Math.ceil(D/h)}[b]}),l+="<div class='boss "+(C/h>=a.ratio?"boss-killed":"")+"'><img class='boss-icon' src='http://media.blizzard.com/wow/renders/npcs/portrait/creature"+q[i].icons[f]+".jpg'><span class='boss-name'>"+r(H[f].name)+"</span><span class='boss-status'>"+g+"</span></div>")}else v-=1,w-=1;e=Math.round(100*(A/w))+"%";g=a.count.replace(/\{[n|p|t]\}/g,function(a){return{"{p}":e,"{n}":A,"{t}":w}[a]});k="<div class='inst'><div class='inst-title'>Normal <span class='inst-count'>"+ A+"/"+w+" ("+e+")</span></div></div>"+k;k+="<div class='details'"+(a.details?"":" style='display:none'")+"><hr><table><tr><td>Raider</td><td class='mono'>"+s.join(" ")+"</td></tr>";for(b=0;b<h;b++)k+="<tr><td>"+x[b].shift()+"</td><td class='mono'>"+x[b].join(" ")+"</td></tr>";k+="</table></div>";p+='<table class="instance inst-'+q[i].abbr+'"><tr><td'+(a.heroics&&q[i].hasHeroic?' rowspan="2"':"")+' class="icon"><div class="icon"></div></td><td><span class="inst-name">'+q[i][a.useAbbr?"abbr":"name"]+ '</span><div class="bar-bkgd bar-normal '+a.tooltip+'" title="<div class=tips>'+k+'</div>"><div class="bar-color" style="width: '+e+';"><span class="bar-text">'+g+"</span></div></td></tr>";if(a.heroics&&q[i].hasHeroic){e=Math.round(100*(j/v))+"%";g=a.count.replace(/\{[n|p|t]\}/g,function(a){return{"{p}":e,"{n}":j,"{t}":v}[a]});l="<div class='inst'><div class='inst-title'>Heroic <span class='inst-count'>"+j+"/"+v+" ("+e+")</span></div></div>"+l;l+="<div class='details'"+(a.details?"":" style='display:none'")+ "><hr><table><tr><td>Raider</td><td class='mono'>"+s.join(" ")+"</td></tr>";for(b=0;b<h;b++)l+="<tr><td>"+y[b].shift()+"</td><td class='mono'>"+y[b].join(" ")+"</td></tr>";l+="</table></div>";p+='<tr><td><div class="bar-bkgd bar-heroic '+a.tooltip+'" title="<div class=tips>'+l+'"><div class="bar-color" style="width: '+e+';"><span class="bar-text">'+g+"</span></div></div></td></tr>"}p+="</div>"}p+="</table></div>"}m(F).addClass("wowprogression").html(p);!a.details&&a.clickForDetails&&m(F).find(".bar-bkgd").bind("click", function(){m(".tips .details").toggle()});F.initialized=!0;"function"===typeof a.initialized&&a.initialized(F)}))}})}})(jQuery);

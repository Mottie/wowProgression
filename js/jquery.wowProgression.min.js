(function(h){h.fn.wowProgression=function(H){return this.each(function(){if(!this.initialized){var w=this,c=h.extend({region:"us",locale:"en_US",server:"Lightning's Blade",guild:"Our Guild's Name",raiders:{},show:["mists"],flex:!0,heroics:!0,ratio:0.75,count:"{p}",status:"{s}",useAbbr:!1,text:{zero:"",none:"",killed:"Killed"},tooltip:"tooltip",allexps:{mists:"Mists of Pandaria",cat:"Catacylsm"},allraids:{mists:[{abbr:"SoO",hasHeroic:!0,id:6738,icons:[71543,71475,71965,71734,72249,72616,71859,71515,
71454,71889,71529,71504,71152,71865]},{abbr:"ToT",hasHeroic:!0,id:6622,icons:[69465,68476,69078,67977,68066,68177,67827,69017,69427,68078,68904,68397,69473],heroicBoss:!0},{abbr:"ToES",hasHeroic:!0,id:6067,icons:[60583,62442,62983,60999]},{abbr:"HoF",hasHeroic:!0,id:6297,icons:[62980,62543,62164,62397,62511,62837]},{abbr:"MV",hasHeroic:!0,id:6125,icons:[60051,60009,60143,60701,60410,60396]}],cat:[{abbr:"DS",hasHeroic:!0,id:5892,icons:[55265,55308,55312,55689,55294,56427,53879,57962]},{abbr:"FL",hasHeroic:!0,
id:5723,icons:[52498,52558,53691,52530,53494,52571,52409]},{abbr:"ToFW",hasHeroic:!0,id:5638,icons:[45871,46753]},{abbr:"BoT",hasHeroic:!0,id:5334,icons:[44600,45993,43687,43324,45213],heroicBoss:!0},{abbr:"BD",hasHeroic:!0,id:5094,icons:[42179,41570,41442,43296,41378,41376]},{abbr:"BH",hasHeroic:!1,id:5600,icons:[47120,52363,55869]}]},initialized:null,details:!1,clickForDetails:!0,grouping:4,debug:!1},H),F="http://"+("cn"===c.region?"www.battlenet.com.cn":c.region+".battle.net")+"/api/wow/character/"+
c.server+"/",p=[],r={},A=[],s,B=!1,v={},x=function(a){console&&console.log&&console.log(a)},I=function(a){return jQuery.getJSON(F+a+"?locale="+c.locale+"&fields=progression&jsonp=?",function(b){if(b&&b.progression){var a=b.name.toLocaleLowerCase();A.push(a);p.push(b.progression.raids);c.debug&&x([a,"URL: "+F+a+"?locale="+c.locale+"&fields=progression",b])}})},m=function(a){return a.replace(/'/g,"'").replace(/"/g,"&quot;")},J=function(a){return a.replace(/[<>]/g,function(a){return{"<":"&lt;",">":"&gt;"}[a]})},
C=function(a,b,g,e,f,t){var h=e.counts[a]/f>=c.ratio,p=m(c.status).replace(/\{(s|n)\}/g,function(b){return{"{s}":h?m(c.text.killed):m(c.text.none),"{n}":e.totals[a]/f<c.ratio?m(c.text.zero):Math.ceil(e.totals[a]/f)}[b]});g="<div class='boss "+(h?"boss-killed":"")+"'><img class='boss-icon' src='http://media.blizzard.com/wow/renders/npcs/portrait/creature"+g+".jpg'><span class='boss-name'>"+m(b)+"</span><span class='boss-status'>"+p+"</span></div>";c.debug&&(t[b]="ratio: "+e.counts[a]/f+", "+a+": "+
(e.counts[a]/f>=c.ratio?"+":"-")+", ");return g},K=function(a,b,g){var e="<div class=inst><div class=inst-title>"+a+" <span class=inst-count>"+b.kills[a]+"/"+b.bosses[a]+" ("+g+")</span></div></div>"+b.tips[a],e=e+("<div class=details"+(c.details?"":" style='display:none'")+"><hr><table><tr><td>Raider</td><td class=mono>"+b.detailsIndex[a].join("")+"</td></tr>");h.each(b.details[a],function(a,b){b&&(e+="<tr><td>"+b.shift()+"</td><td class=mono>"+b.join("")+"</td></tr>")});e+="</table></div>";return"<div class=tips>"+
e+"</div>"},D=function(a,b){var g=Math.round(100*(b.kills[a]/b.bosses[a]))+"%",e=c.count.replace(/\{[n|p|t]\}/g,function(c){return{"{p}":g,"{n}":b.kills[a],"{t}":b.bosses[a]}[c]});return'<div class="bar-bkgd bar-'+a+" "+c.tooltip+'" title="'+J(K(a,b,g))+'"><div class="bar-color" style="width: '+g+';"><span class="bar-text">'+e+"</span></div></div>"},E=function(a,b,g,e,f){g=g[a+"Kills"];f="<span class=group"+Math.floor(f/c.grouping)+">";0<g?(b.details[a][e].push(f+"+</span>"),b.counts[a]++,b.totals[a]+=
g):b.details[a][e].push(f+"-</span>")},G=function(){if(!B){var a,b,g,e,f,t,y,s,m,q,k,z,n,u,l="",d={hasFlex:"",tips:{},counts:{},bosses:{},kills:{},totals:{},details:{},detailsIndex:{}};for(a=0;a<c.show.length;a++){n=c.show[a];v[n]={};k=c.allraids[n];u=r[n].length;l+='<h3 class="expansion expansion-'+n+'">'+c.allexps[n]+'</h3><div class="instances instances-'+n+'">';for(b=0;b<k.length;b++)if(p[0])for(g=0;g<p[0].length;g++)if((q=p[0][g]||null)&&q.id===k[b].id){k[b].name=q.name;v[n][q.name]={};z=q.bosses;
m=z.length;d.tips={flex:"",normal:"",heroic:""};d.details={flex:[],normal:[],heroic:[]};d.detailsIndex={flex:[],normal:[],heroic:[]};d.bosses={flex:m,normal:m,heroic:m};d.kills={flex:0,normal:0,heroic:0};d.hasFlex="";for(e=0;e<m;e++)if(k[b].icons[e]){f="<span class=group"+Math.floor(e/c.grouping)+">"+(e+1)%10+"</span>";if(s=!k[b].heroicBoss||k[b].heroicBoss&&e<q.bosses.length-1)d.detailsIndex.normal.push(f),d.detailsIndex.flex.push(f);d.detailsIndex.heroic.push(f);d.counts={flex:0,normal:0,heroic:0};
d.totals={flex:0,normal:0,heroic:0};for(f=0;f<u;f++)y=r[n][f],t=h.inArray((y||"").toLocaleLowerCase(),A),0<=t&&(d.details.flex[f]||(d.details.flex[f]=[y]),d.details.normal[f]||(d.details.normal[f]=[y]),d.details.heroic[f]||(d.details.heroic[f]=[y]),""===d.hasFlex&&(d.hasFlex=!!p[t][g].bosses[e].flexKills),s&&(d.hasFlex&&E("flex",d,p[t][g].bosses[e],f,e),E("normal",d,p[t][g].bosses[e],f,e)),E("heroic",d,p[t][g].bosses[e],f,e));d.hasFlex&&d.counts.flex/u>=c.ratio&&d.kills.flex++;d.counts.normal/u>=
c.ratio&&d.kills.normal++;d.counts.heroic/u>=c.ratio&&d.kills.heroic++;k[b].heroicBoss&&e===q.bosses.length-1?(d.bosses.flex--,d.bosses.normal--):(d.tips.normal+=C("normal",z[e].name,k[b].icons[e],d,u,v[n][q.name]),d.hasFlex&&c.flex&&(d.tips.flex+=C("flex",z[e].name,k[b].icons[e],d,u,v[n][q.name])),c.heroics&&(d.tips.heroic+=C("heroic",z[e].name,k[b].icons[e],d,u,v[n][q.name])))}else d.bosses.flex--,d.bosses.normal--,d.bosses.heroic--;f=(d.hasFlex&&c.flex?2:1)+(c.heroics&&k[b].hasHeroic?1:0);l+='<table class="instance inst-'+
k[b].abbr+'"><tr><td rowspan="'+f+'" class="icon"><div class="icon"></div></td><td><span class="inst-name">'+k[b][c.useAbbr?"abbr":"name"]+"</span>";d.hasFlex&&c.flex&&(l+=D("flex",d)+"</td></tr><tr><td>");l+=D("normal",d)+"</td></tr>";c.heroics&&k[b].hasHeroic&&(l+="<tr><td>"+D("heroic",d)+"</td></tr>");l+="</div>"}l+="</table></div>"}c.debug&&x(v);h(w).addClass("wowprogression").html(l);!c.details&&c.clickForDetails&&h(w).find(".bar-bkgd").unbind("click").bind("click",function(){h(".tips .details").toggle()});
"function"!==typeof c.initialized||w.initialized||c.initialized(w);w.initialized=!0}};s=function(){var a,b,g,e,f=[],m=[];for(b in c.raiders)if(c.raiders.hasOwnProperty(b)&&("all"===b||0<=h.inArray(b,c.show))){a=c.raiders[b];for(g=0;g<a.length;g++)if(""!==a[g])if(f.push(a[g]),"all"===b)for(e=0;e<c.show.length;e++)r[c.show[e]]||(r[c.show[e]]=[]),r[c.show[e]].push(a[g]);else r[b]||(r[b]=[]),r[b].push(a[g]);c.debug&&x("Expansion ("+b+") raiders: "+a)}f=h.grep(f,function(a,b){return h.inArray(a,f)===b});
for(a=0;a<f.length;a++)f[a]&&(f[a]=f[a].toLocaleLowerCase(),m.push(I(f[a])));return m}();s.length&&(s=h.when.apply(h,s),s.done(function(){c.debug&&x("Loading complete: processing...");G();B=!0}),setTimeout(function(){0<A.length&&(c.debug&&!B&&x("One or more raiders' JSON feeds failed to load..."),G())},2E3))}})}})(jQuery);

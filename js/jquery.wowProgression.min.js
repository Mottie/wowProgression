/*! WoW Progression v1.2
	by Rob G (Mottie)
	https://github.com/Mottie/wowProgression
	http://www.opensource.org/licenses/mit-license.php
*/
;(function(p){p.fn.wowProgression=function(N){return this.each(function(){if(!this.initialized){var B=this,a=p.extend({region:"us",locale:"en_US",server:"Lightning's Blade",guild:"Our Guild's Name",raiders:{},show:["mists"],heroics:!0,ratio:0.75,count:"{p}",status:"{s}",useAbbr:!1,text:{zero:"",none:"",killed:"Killed"},tooltip:"tooltip",allexps:{mists:"Mists of Pandaria",cat:"Catacylsm"},allraids:{mists:[{abbr:"ToT",hasHeroic:!0,name:"Throne of Thunder",icons:[69465,68476,69078,67977,68066,68177,67827, 69017,69427,68078,68904,68397,69473],heroicBoss:!0},{abbr:"ToES",hasHeroic:!0,name:"Terrace of Endless Spring",icons:[60583,62442,62983,60999]},{abbr:"HoF",hasHeroic:!0,name:"Heart of Fear",icons:[62980,62543,62164,62397,62511,62837]},{abbr:"MV",hasHeroic:!0,name:"Mogu'shan Vaults",icons:[60051,60009,60143,60701,60410,60396]}],cat:[{abbr:"DS",hasHeroic:!0,name:"Dragon Soul",icons:[55265,55308,55312,55689,55294,56427,53879,57962]},{abbr:"FL",hasHeroic:!0,name:"Firelands",icons:[52498,52558,53691,52530, 53494,52571,52409]},{abbr:"ToFW",hasHeroic:!0,name:"Throne of the Four Winds",icons:[45871,46753]},{abbr:"BoT",hasHeroic:!0,name:"The Bastion of Twilight",icons:[44600,45993,43687,43324,45213],heroicBoss:!0},{abbr:"BD",hasHeroic:!0,name:"Blackwing Descent",icons:[42179,41570,41442,43296,41378,41376]},{abbr:"BH",hasHeroic:!1,name:"Baradin Hold",icons:[47120,52363,55869]}]},initialized:null,details:!1,clickForDetails:!0},N),O="http://"+("cn"===a.region?"www.battlenet.com.cn":a.region+".battle.net")+ "/api/wow/character/"+a.server+"/",u=[],v={},J=[],t,L=!1;t=function(c){return jQuery.getJSON(O+c+"?locale="+a.locale+"&fields=progression&jsonp=?",function(a){a&&a.progression&&(J.push(a.name.toLocaleLowerCase()),u.push(a.progression.raids))})};var s=function(a){return a.replace(/'/g,"'").replace(/"/g,"&quot;")},M=function(){if(!L){var c,j,d,f,b,g,e,m,n,C,w,z,D,E,t,x,y,q="",F,G,k,l,H,r,I,A,h;for(c=0;c<a.show.length;c++){A=a.show[c];r=a.allraids[A];h=v[A].length;q+='<h3 class="expansion expansion-'+ A+'">'+a.allexps[A]+'</h3><div class="instances instances-'+A+'">';for(j=0;j<r.length;j++)if(u[0])for(d=0;d<u[0].length;d++)if((H=u[0][d]||null)&&H.name===r[j].name){l=k="";t=[];x=[];y=[];I=H.bosses;n=C=0;z=w=I.length;for(f=0;f<w;f++)if(r[j].icons[f]){t.push(f+1);for(b=F=E=G=D=0;b<h;b++)m=v[A][b],g=p.inArray((m||"").toLocaleLowerCase(),J),0<=g&&(x[b]||(x[b]=[m]),y[b]||(y[b]=[m]),0<u[g][d].bosses[f].normalKills?(x[b].push("+"),D++,G+=u[g][d].bosses[f].normalKills):x[b].push("-"),0<u[g][d].bosses[f].heroicKills? (y[b].push("+"),E++,F+=u[g][d].bosses[f].heroicKills):y[b].push("-"));D/h>=a.ratio&&C++;E/h>=a.ratio&&n++;g=s(a.status).replace(/\{(s|n)\}/g,function(b){return{"{s}":D/h>=a.ratio?s(a.text.killed):s(a.text.none),"{n}":G/h<a.ratio?s(a.text.zero):Math.ceil(G/h)}[b]});r[j].heroicBoss&&f===H.bosses.length-1?z=w-1:k+="<div class='boss "+(D/h>=a.ratio?"boss-killed":"")+"'><img class='boss-icon' src='http://media.blizzard.com/wow/renders/npcs/portrait/creature"+r[j].icons[f]+".jpg'><span class='boss-name'>"+ s(I[f].name)+"</span><span class='boss-status'>"+g+"</span></div>";a.heroics&&(g=s(a.status).replace(/\{(s|n)\}/g,function(b){return{"{s}":E/h>=a.ratio?s(a.text.killed):s(a.text.none),"{n}":F/h<a.ratio?s(a.text.zero):Math.ceil(F/h)}[b]}),l+="<div class='boss "+(E/h>=a.ratio?"boss-killed":"")+"'><img class='boss-icon' src='http://media.blizzard.com/wow/renders/npcs/portrait/creature"+r[j].icons[f]+".jpg'><span class='boss-name'>"+s(I[f].name)+"</span><span class='boss-status'>"+g+"</span></div>")}else w-= 1,z-=1;e=Math.round(100*(C/z))+"%";g=a.count.replace(/\{[n|p|t]\}/g,function(a){return{"{p}":e,"{n}":C,"{t}":z}[a]});k="<div class='inst'><div class='inst-title'>Normal <span class='inst-count'>"+C+"/"+z+" ("+e+")</span></div></div>"+k;k+="<div class='details'"+(a.details?"":" style='display:none'")+"><hr><table><tr><td>Raider</td><td class='mono'>"+t.join(" ")+"</td></tr>";for(b=0;b<h;b++)x[b]&&(k+="<tr><td>"+x[b].shift()+"</td><td class='mono'>"+x[b].join(" ")+"</td></tr>");k+="</table></div>"; q+='<table class="instance inst-'+r[j].abbr+'"><tr><td'+(a.heroics&&r[j].hasHeroic?' rowspan="2"':"")+' class="icon"><div class="icon"></div></td><td><span class="inst-name">'+r[j][a.useAbbr?"abbr":"name"]+'</span><div class="bar-bkgd bar-normal '+a.tooltip+'" title="<div class=tips>'+k+'</div>"><div class="bar-color" style="width: '+e+';"><span class="bar-text">'+g+"</span></div></td></tr>";if(a.heroics&&r[j].hasHeroic){e=Math.round(100*(n/w))+"%";g=a.count.replace(/\{[n|p|t]\}/g,function(a){return{"{p}":e, "{n}":n,"{t}":w}[a]});l="<div class='inst'><div class='inst-title'>Heroic <span class='inst-count'>"+n+"/"+w+" ("+e+")</span></div></div>"+l;l+="<div class='details'"+(a.details?"":" style='display:none'")+"><hr><table><tr><td>Raider</td><td class='mono'>"+t.join(" ")+"</td></tr>";for(b=0;b<h;b++)y[b]&&(l+="<tr><td>"+y[b].shift()+"</td><td class='mono'>"+y[b].join(" ")+"</td></tr>");l+="</table></div>";q+='<tr><td><div class="bar-bkgd bar-heroic '+a.tooltip+'" title="<div class=tips>'+l+'"><div class="bar-color" style="width: '+ e+';"><span class="bar-text">'+g+"</span></div></div></td></tr>"}q+="</div>"}q+="</table></div>"}p(B).addClass("wowprogression").html(q);!a.details&&a.clickForDetails&&p(B).find(".bar-bkgd").unbind("click").bind("click",function(){p(".tips .details").toggle()});"function"===typeof a.initialized&&!B.initialized&&a.initialized(B);B.initialized=!0}},c,d,m,n,e=[],K=[];for(d in a.raiders)if(a.raiders.hasOwnProperty(d)&&("all"===d||0<=p.inArray(d,a.show))){c=a.raiders[d];for(m=0;m<c.length;m++)if(""!== c[m])if(e.push(c[m]),"all"===d)for(n=0;n<a.show.length;n++)v[a.show[n]]||(v[a.show[n]]=[]),v[a.show[n]].push(c[m]);else v[d]||(v[d]=[]),v[d].push(c[m])}e=p.grep(e,function(a,c){return p.inArray(a,e)===c});for(c=0;c<e.length;c++)e[c]&&(e[c]=e[c].toLocaleLowerCase(),K.push(t(e[c])));K.length&&(t=p.when.apply(p,K),t.done(function(){M();L=!0}),setTimeout(function(){0<J.length&&M()},2E3))}})}})(jQuery);
